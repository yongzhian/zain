<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.flwrobot.dao.CommunityOwnerRequestDao">

	<resultMap type="com.flwrobot.entity.CommunityOwnerRequest" id="communityOwnerRequest">
		<id column="id" property="id"/>
		
		<id column="room_id" property="roomId"/>
		<id column="user_id" property="userId"/>
		
		<id column="request_desc" property="requestDesc"/>
		<id column="create_time" property="createTime"/>
		<id column="owner_name" property="ownerName"/>
		
		<id column="owner_phone_no" property="ownerPhoneNo"/>
		<id column="read_time" property="readTime"/>
		<id column="handle_people" property="handlePeople"/>
		
		<id column="handle_time" property="handleTime"/>
		<id column="handle_result" property="handleResult"/>
		<id column="handle_remark" property="handleRemark"/>
		
		<id column="is_valid" property="isValid"/>
		
		<id column="buiding_no" property="buildingNO"/>
		<id column="room_no" property="roomNO"/>
		<id column="room_owner_name" property="ownerName4Room"/>
		<id column="owner_tel" property="ownerTel"/>

	</resultMap>
	
	<select id="getOwnerRequestNumByCondition" resultType="long">
		SELECT COUNT(1)
		FROM community_owner_request cor, community_room cr, community_buiding cb
		<trim prefix="WHERE" prefixOverrides="AND">
			cor.room_id = cr.id AND cr.buiding_id = cb.id   AND cor.is_valid='T'
			<if test="conditionMap.containsKey('handleResult')">
				AND cor.handle_result=#{conditionMap.handleResult}
			</if>
			<if test="conditionMap.containsKey('notHandleResult')">
				AND cor.handle_result!=#{conditionMap.notHandleResult}
			</if>
			<if test="conditionMap.containsKey('communityManagementId')">
				AND cb.management_id=#{conditionMap.communityManagementId}
			</if>
			<if test="conditionMap.containsKey('buidingId')">
				AND cr.buiding_id = #{conditionMap.buidingId}
			</if>
			<if test="conditionMap.containsKey('roomId')">
				AND cor.room_id = #{conditionMap.roomId}
			</if>
			<if test="conditionMap.containsKey('requestTimeFrom')">
				AND cor.create_time >= #{conditionMap.requestTimeFrom}
			</if>
			<if test="conditionMap.containsKey('requestTimeTo')">
				<![CDATA[
					AND cor.create_time <= #{conditionMap.requestTimeTo}
				]]>
			</if>
		</trim>
	</select>
	
	<select id="getOwnerRequestListByCondition"   parameterType="Map" resultMap="communityOwnerRequest">
		SELECT cor.*,cb.buiding_no,cr.room_no,cr.owner_tel,cr.owner_name as room_owner_name
		FROM community_owner_request cor, community_room cr, community_buiding cb
		<trim prefix="WHERE" prefixOverrides="AND">
			cor.room_id = cr.id AND cr.buiding_id = cb.id   AND cor.is_valid='T'
			<if test="conditionMap.containsKey('handleResult')">
				AND cor.handle_result=#{conditionMap.handleResult}
			</if>
			<if test="conditionMap.containsKey('notHandleResult')">
				AND cor.handle_result!=#{conditionMap.notHandleResult}
			</if>
			<if test="conditionMap.containsKey('communityManagementId')">
				AND cb.management_id=#{conditionMap.communityManagementId}
			</if>
			<if test="conditionMap.containsKey('buidingId')">
				AND cr.buiding_id = #{conditionMap.buidingId}
			</if>
			<if test="conditionMap.containsKey('roomId')">
				AND cor.room_id = #{conditionMap.roomId}
			</if>
			<if test="conditionMap.containsKey('requestTimeFrom')">
				AND cor.create_time >= #{conditionMap.requestTimeFrom}
			</if>
			<if test="conditionMap.containsKey('requestTimeTo')">
				<![CDATA[
					AND cor.create_time <= #{conditionMap.requestTimeTo}
				]]>
			</if>
		</trim>
		<if test="conditionMap.containsKey('orderBy')">
            ORDER BY   handle_result ${conditionMap.orderBy}, create_time ${conditionMap.orderBy},id ${conditionMap.orderBy}
       </if>
       <if  test="conditionMap.containsKey('beginItem') and conditionMap.containsKey('endItem') ">
            LIMIT ${conditionMap.beginItem},${conditionMap.endItem}
       </if>
	</select>
	
	<update id="modifyCommunityOwnerRequestListByCondition">
        update community_owner_request 
            <trim prefix="SET" suffixOverrides=",">
                <if test="settingsMap.containsKey('handleResult')">
                    handle_result = #{settingsMap.handleResult},
                </if>
                <if test="settingsMap.containsKey('handlePeople')">
                    handle_people = #{settingsMap.handlePeople},
                </if>
                <if test="settingsMap.containsKey('handleRemark')">
                    handle_remark = #{settingsMap.handleRemark},
                </if>
                <if test="settingsMap.containsKey('handleTime')">
                    handle_time = now(),
                </if>
                <if test="settingsMap.containsKey('readTime')">
                    read_time = now(),
                </if>
            </trim>

            <trim prefix="WHERE" prefixOverrides="AND">
                <if test="conditionMap.containsKey('id')">
                    AND id = #{conditionMap.id}
                </if>
            </trim>
    </update>
</mapper>